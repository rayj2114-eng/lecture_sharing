<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High School Bulletin Board</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Set GIF Background and ensure it covers the screen (cropping if needed) */
            background-image: url('burn-elmo.gif');
            background-size: cover;
            background-position: center;
            background-attachment: fixed; /* Keeps the background fixed while content scrolls */
        }
    </style>
</head>
<body>

    <div id="app-container" class="max-w-3xl mx-auto p-4 sm:p-6">
        <header class="mb-8">
            <!-- Updated text color and added shadow for contrast against the background -->
            <h1 class="text-4xl font-bold text-white text-center mb-2" style="text-shadow: 0 0 5px black;">Burn the World</h1>
            
            <!-- User Info and Username Change Feature -->
            <div class="bg-white p-4 rounded-xl shadow-lg mt-4 border border-gray-100">
                <div id="user-info" class="text-sm text-center mb-3">
                    <span class="font-medium text-indigo-600">Your User ID: </span>
                    <span id="current-user-id" class="break-all text-gray-500">Loading...</span>
                </div>

                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                    <div class="text-center sm:text-left flex-shrink-0">
                        <span class="font-medium text-gray-700">Current Name: </span>
                        <span id="current-username-display" class="font-bold text-indigo-700">Loading...</span>
                    </div>

                    <div class="flex w-full sm:w-auto space-x-2">
                        <input type="text" id="username-input" 
                               placeholder="New Username"
                               class="flex-grow p-2 text-sm border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                        <button onclick="updateUsername()"
                                class="flex-shrink-0 px-4 py-2 bg-indigo-500 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-indigo-600 transition duration-200">
                            Change Name
                        </button>
                    </div>
                </div>
            </div>

            <!-- Filter Control -->
            <div class="flex justify-center mt-6">
                <label class="flex items-center space-x-2 p-3 bg-white rounded-xl shadow-md cursor-pointer hover:bg-indigo-50 transition duration-150 border border-gray-200">
                    <input type="checkbox" id="my-posts-toggle" onchange="toggleMyPosts(this.checked)" 
                           class="h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded-full cursor-pointer">
                    <span class="text-base font-semibold text-gray-700">Show My Posts Only</span>
                </label>
            </div>
        </header>

        <!-- New Thread Form -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Start a New Thread</h2>
            <textarea id="thread-content"
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                      rows="3"
                      placeholder="What's on your mind?"></textarea>
            <button onclick="handlePost(null)"
                    class="mt-3 w-full sm:w-auto px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-200">
                Post Thread
            </button>
        </div>

        <!-- Threads Container -->
        <div id="threads-container">
            <p id="loading-message" class="text-center text-white p-8" style="text-shadow: 0 0 5px black;">Loading posts...</p>
        </div>
    </div>

    <!-- Modal for Custom Confirmation/Alerts -->
    <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 id="modal-title" class="text-lg font-bold mb-3 text-gray-800"></h3>
            <p id="modal-message" class="text-gray-600 mb-4"></p>
            <button onclick="hideModal()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Imports for Firestore functions including setDoc for user profile creation
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, getDoc, setDoc, increment, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Variables provided by Canvas environment ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let currentUserId = 'anonymous'; // Will be updated after auth
        let currentUsername = 'GuestUser'; // Will be loaded from Firestore
        let allPostsCache = []; // Store all fetched posts
        let showMyPostsOnly = false; // State for the filter

        // --- Utility Functions ---

        /** Shows a custom modal instead of alert() */
        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('modal-backdrop').classList.add('flex');
        }

        /** Hides the custom modal */
        window.hideModal = function() {
            document.getElementById('modal-backdrop').classList.add('hidden');
            document.getElementById('modal-backdrop').classList.remove('flex');
        }

        /** Formats a Firestore timestamp or number into a readable string */
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Just now';
            let date;
            if (typeof timestamp.toDate === 'function') {
                date = timestamp.toDate();
            } else if (typeof timestamp === 'number') {
                date = new Date(timestamp);
            } else {
                return 'Unknown time';
            }
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        /** Toggles the 'Show My Posts Only' filter and re-renders the threads. */
        window.toggleMyPosts = function(isChecked) {
            showMyPostsOnly = isChecked;
            renderThreads(allPostsCache); // Re-render with the new filter applied to the cached data
        }

        // --- Firebase Setup and Authentication ---

        const getUsersCollectionRef = () => {
            // Public collection path for user profiles: /artifacts/{appId}/public/data/users
            return collection(db, `artifacts/${appId}/public/data/users`);
        }
        
        const getUserDocRef = (userId) => {
            return doc(db, `artifacts/${appId}/public/data/users`, userId);
        }

        /** Fetches or creates the user's public profile (username). */
        async function initializeUserProfile(userId) {
            const userDocRef = getUserDocRef(userId);
            const userSnap = await getDoc(userDocRef);
            const defaultUsername = `User-${userId.substring(0, 8)}`;

            if (userSnap.exists()) {
                // User exists, load username
                currentUsername = userSnap.data().username || defaultUsername;
            } else {
                // New user, create profile
                currentUsername = defaultUsername;
                await setDoc(userDocRef, {
                    username: currentUsername,
                    created_at: Date.now()
                });
            }
            // Update UI with the loaded/default username
            document.getElementById('current-username-display').textContent = currentUsername;
            document.getElementById('username-input').value = currentUsername;
        }

        /** Updates the user's display name in Firestore and local state. */
        window.updateUsername = async function() {
            if (!currentUserId) {
                showModal("Access Denied", "Authentication required to change username.");
                return;
            }
            const inputElement = document.getElementById('username-input');
            const newUsername = inputElement.value.trim();
            
            if (newUsername.length < 3 || newUsername.length > 20) {
                showModal("Input Error", "Username must be between 3 and 20 characters long.");
                return;
            }
            if (newUsername === currentUsername) {
                showModal("No Change", "That is already your current username.");
                return;
            }
            
            const userDocRef = getUserDocRef(currentUserId);
            
            try {
                // Update Firestore profile
                await updateDoc(userDocRef, { username: newUsername });
                
                // Update local state and UI
                currentUsername = newUsername;
                document.getElementById('current-username-display').textContent = currentUsername;

                showModal("Success", `Username successfully changed to ${newUsername}. New posts will use this name.`);
            } catch (e) {
                console.error("Error updating username:", e);
                showModal("Update Error", "Failed to update username. Please try again.");
            }
        }

        async function setupAuthAndFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Try to sign in with the provided token, otherwise sign in anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('current-user-id').textContent = currentUserId;
                        
                        // Initialize user profile (fetch or create username)
                        await initializeUserProfile(user.uid); 

                        listenForPosts(); // Start listening for data once authenticated
                    } else {
                        currentUserId = null;
                        document.getElementById('current-user-id').textContent = 'Not signed in';
                        document.getElementById('current-username-display').textContent = 'N/A';
                        document.getElementById('username-input').value = '';
                    }
                });
            } catch (error) {
                console.error("Error setting up Firebase:", error);
                showModal("Setup Error", "Failed to initialize Firebase or authenticate. Check console for details.");
            }
        }

        // --- Firestore Operations (Posts) ---

        const getPostsCollectionRef = () => {
            // Public collection path: /artifacts/{appId}/public/data/posts
            return collection(db, `artifacts/${appId}/public/data/posts`);
        }
        
        const getPostDocRef = (postId) => {
            return doc(db, `artifacts/${appId}/public/data/posts`, postId);
        }

        /** Handles posting a new thread or a reply. */
        window.handlePost = async function(parentId) {
            if (!currentUserId) {
                showModal("Access Denied", "Please wait for authentication to complete before posting.");
                return;
            }

            const inputId = parentId ? `reply-content-${parentId}` : 'thread-content';
            const contentInput = document.getElementById(inputId);
            const content = contentInput.value.trim();

            if (!content) {
                showModal("Empty Post", "Your post cannot be empty.");
                return;
            }
            
            // Disable button during post submission
            const button = contentInput.nextElementSibling;
            if (button && button.tagName === 'BUTTON') button.disabled = true;

            const newPost = {
                userId: currentUserId,
                username: currentUsername, // Use the current, updated username
                content: content,
                timestamp: Date.now(),
                parentId: parentId || null,
                // Initialize vote counts and map
                likeCount: 0,
                dislikeCount: 0,
                votes: {} // Stores userId: 1 (like) or -1 (dislike)
            };

            try {
                await addDoc(getPostsCollectionRef(), newPost);
                contentInput.value = ''; // Clear input field

                // Hide reply form if it was a reply
                if (parentId) {
                    toggleReplyForm(parentId);
                }

            } catch (e) {
                console.error("Error adding document: ", e);
                showModal("Post Error", "Failed to submit post. Please try again.");
            } finally {
                 if (button && button.tagName === 'BUTTON') button.disabled = false;
            }
        }
        
        /** Handles liking or disliking a post. (Supports multiple users) */
        window.handleVote = async function(postId, voteType) {
            if (!currentUserId) {
                showModal("Access Denied", "You must be signed in to vote.");
                return;
            }
            if (!db) return;

            const postRef = getPostDocRef(postId);

            try {
                // 1. Get the current vote status
                const docSnap = await getDoc(postRef);
                if (!docSnap.exists()) {
                    showModal("Error", "Post not found.");
                    return;
                }
                
                const postData = docSnap.data();
                const currentVote = postData.votes?.[currentUserId] || 0;
                const newVoteValue = voteType; // 1 (like) or -1 (dislike)
                
                let updatePayload = {};
                let voteChanged = false;

                if (currentVote === newVoteValue) {
                    // Scenario 1: User is removing their existing vote (undo)
                    const voteKey = currentVote === 1 ? 'likeCount' : 'dislikeCount';
                    
                    updatePayload = {
                        [voteKey]: increment(-1), // Decrement count
                        [`votes.${currentUserId}`]: deleteField() // Remove user's vote entry
                    };
                    voteChanged = true;
                } else if (currentVote === 0) {
                    // Scenario 2: User is setting a new vote
                    const voteKey = newVoteValue === 1 ? 'likeCount' : 'dislikeCount';

                    updatePayload = {
                        [voteKey]: increment(1), // Increment new count
                        [`votes.${currentUserId}`]: newVoteValue // Set user's vote
                    };
                    voteChanged = true;
                } else {
                    // Scenario 3: User is switching their vote (e.g., from like to dislike)
                    const oldVoteKey = currentVote === 1 ? 'likeCount' : 'dislikeCount';
                    const newVoteKey = newVoteValue === 1 ? 'likeCount' : 'dislikeCount';

                    updatePayload = {
                        [oldVoteKey]: increment(-1), // Decrement old count
                        [newVoteKey]: increment(1),  // Increment new count
                        [`votes.${currentUserId}`]: newVoteValue // Update user's vote
                    };
                    voteChanged = true;
                }

                if (voteChanged) {
                    await updateDoc(postRef, updatePayload);
                }
                // The onSnapshot listener will automatically re-render the post with the new counts.

            } catch (e) {
                console.error("Error handling vote:", e);
                showModal("Vote Error", "Failed to submit vote. Please try again.");
            }
        }


        /** Listen for real-time updates to all posts */
        function listenForPosts() {
            const postsRef = getPostsCollectionRef();
            const q = query(postsRef); // We'll sort in memory
            
            const loadingMessage = document.getElementById('loading-message'); // Get element reference
            if (loadingMessage) { // Check if element exists before accessing properties
                loadingMessage.textContent = 'Loading posts...';
                loadingMessage.classList.remove('hidden');
            }

            onSnapshot(q, (querySnapshot) => {
                const fetchedPosts = [];
                querySnapshot.forEach((doc) => {
                    // Ensure default vote structure exists for rendering if missing
                    const data = doc.data();
                    fetchedPosts.push({ 
                        id: doc.id, 
                        ...data,
                        likeCount: data.likeCount || 0,
                        dislikeCount: data.dislikeCount || 0,
                        votes: data.votes || {}
                    });
                });
                
                // --- NEW SORTING LOGIC: Most Liked First, then Newest First for ties ---
                fetchedPosts.sort((a, b) => {
                    // Primary sort: by likeCount (descending)
                    if (b.likeCount !== a.likeCount) {
                        return b.likeCount - a.likeCount; 
                    }
                    // Secondary sort (tie-breaker): by timestamp (descending - newest first)
                    return b.timestamp - a.timestamp; 
                });
                // --- END NEW SORTING LOGIC ---

                allPostsCache = fetchedPosts; // Cache the full list, now sorted by likes
                renderThreads(allPostsCache); // Render based on the current filter state
            }, (error) => {
                console.error("Error listening to posts:", error);
                const loadingMessage = document.getElementById('loading-message');
                if (loadingMessage) {
                    loadingMessage.textContent = 'Failed to load posts.';
                }
            });
        }

        // --- Rendering Logic ---

        /** Creates the HTML for a single post's header and content (reusable part) */
        function createPostContent(post, isNested = false) {
            const postDiv = document.createElement('div');
            // Main threads get the strong blue border; nested replies get a lighter background.
            postDiv.className = !isNested
                ? 'bg-white p-4 rounded-xl shadow-md relative border-l-4 border-indigo-600' // Main Thread Card
                : 'bg-gray-50 p-3 rounded-lg relative'; // Nested Reply Box
            
            const header = document.createElement('div');
            header.className = 'flex items-center justify-between mb-1';
            
            const nameTime = document.createElement('div');
            nameTime.className = 'flex items-baseline space-x-2';

            const usernameSpan = document.createElement('span');
            usernameSpan.textContent = post.username;
            // Highlight the user's own posts
            usernameSpan.className = 'font-bold text-sm ' + (post.userId === currentUserId ? 'text-indigo-600' : 'text-gray-800');
            
            const timeSpan = document.createElement('span');
            timeSpan.textContent = formatTimestamp(post.timestamp);
            timeSpan.className = 'text-xs text-gray-500';
            
            nameTime.appendChild(usernameSpan);
            nameTime.appendChild(timeSpan);
            header.appendChild(nameTime);

            const userIdSpan = document.createElement('span');
            userIdSpan.textContent = 'UID: ' + post.userId.substring(0, 8);
            userIdSpan.className = 'text-xs text-gray-400 hidden sm:block';
            header.appendChild(userIdSpan);


            const contentP = document.createElement('p');
            contentP.textContent = post.content;
            contentP.className = 'text-gray-700 text-sm whitespace-pre-wrap';
            
            postDiv.appendChild(header);
            postDiv.appendChild(contentP);

            // --- Voting Controls ---
            const voteDiv = document.createElement('div');
            voteDiv.className = 'flex space-x-3 mt-2';
            const userVote = post.votes[currentUserId] || 0;

            // Like Button (Upvote)
            const likeButton = document.createElement('button');
            likeButton.onclick = () => handleVote(post.id, 1);
            const likeActive = userVote === 1;
            likeButton.className = `flex items-center space-x-1 text-xs font-semibold p-1 rounded-full transition duration-150 ${
                likeActive 
                    ? 'bg-indigo-100 text-indigo-700 hover:bg-indigo-200' 
                    : 'text-gray-500 hover:text-indigo-500 hover:bg-gray-100'
            }`;
            likeButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 fill-current ${likeActive ? 'text-indigo-600' : 'text-gray-400'}" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h3"></path>
                </svg>
                <span>${post.likeCount}</span>
            `;
            voteDiv.appendChild(likeButton);

            // Dislike Button (Downvote)
            const dislikeButton = document.createElement('button');
            dislikeButton.onclick = () => handleVote(post.id, -1);
            const dislikeActive = userVote === -1;
            dislikeButton.className = `flex items-center space-x-1 text-xs font-semibold p-1 rounded-full transition duration-150 ${
                dislikeActive 
                    ? 'bg-red-100 text-red-700 hover:bg-red-200' 
                    : 'text-gray-500 hover:text-red-500 hover:bg-gray-100'
            }`;
            dislikeButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 fill-current ${dislikeActive ? 'text-red-600' : 'text-gray-400'}" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h3a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-3"></path>
                </svg>
                <span>${post.dislikeCount}</span>
            `;
            voteDiv.appendChild(dislikeButton);


            postDiv.appendChild(voteDiv);
            
            return postDiv;
        }

        /** Recursively renders a single post and its children (replies). */
        function renderPostAndChildren(post, allPostsByParent, isNested) {
            const postContainer = document.createElement('div');
            // Main thread: large margin. Nested reply: minimal vertical margin.
            postContainer.className = 'post-container relative ' + (isNested ? 'pt-1 pb-1' : 'mb-6');
            
            // 1. Render the current post's content
            const postContent = createPostContent(post, isNested);
            postContainer.appendChild(postContent);

            // 2. Add Reply Button and Form
            const replyActionDiv = document.createElement('div');
            replyActionDiv.className = 'py-2';

            const replyBtn = document.createElement('button');
            replyBtn.textContent = 'Reply';
            replyBtn.className = 'text-xs font-medium text-indigo-500 hover:text-indigo-700 mt-1 pl-2 pr-4';
            replyBtn.onclick = () => toggleReplyForm(post.id);
            replyActionDiv.appendChild(replyBtn);
            postContainer.appendChild(replyActionDiv);

            // Reply Form Container (initially hidden)
            const replyFormContainer = document.createElement('div');
            replyFormContainer.id = `reply-form-${post.id}`;
            replyFormContainer.className = 'mt-1 mb-2 hidden';
            replyFormContainer.innerHTML = `
                <textarea id="reply-content-${post.id}"
                          class="w-full p-2 text-xs border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                          rows="2"
                          placeholder="Replying to ${post.username}..."></textarea>
                <button onclick="handlePost('${post.id}')"
                        class="mt-1 px-3 py-1 bg-indigo-500 text-white text-xs font-semibold rounded-lg shadow-sm hover:bg-indigo-600 transition duration-200">
                    Submit Reply
                </button>
            `;
            postContainer.appendChild(replyFormContainer);
            
            // 3. Render Replies (Children) Recursively
            const replies = allPostsByParent[post.id] || [];
            if (replies.length > 0) {
                // Wrapper for replies to show the vertical connection line
                const repliesWrapper = document.createElement('div');
                // ml-4 provides indentation, border-l-2 is the connecting line, pl-4 pushes content away from the line
                repliesWrapper.className = 'relative mt-2 pt-2 ml-4 border-l-2 border-gray-200'; 
                
                // Sort replies oldest first (ascending timestamp)
                replies.sort((a, b) => a.timestamp - b.timestamp);

                replies.forEach(reply => {
                    // Recursive call with isNested=true
                    const childElement = renderPostAndChildren(reply, allPostsByParent, true); 
                    repliesWrapper.appendChild(childElement);
                });
                postContainer.appendChild(repliesWrapper);
            }

            return postContainer;
        }


        /** Groups posts and renders the entire board */
        function renderThreads(posts) {
            const threadsContainer = document.getElementById('threads-container');
            const loadingMessage = document.getElementById('loading-message');

            if (!threadsContainer) {
                console.error("Threads container element is missing. Cannot render posts.");
                return; 
            }
            
            threadsContainer.innerHTML = '';

            if (loadingMessage) {
                loadingMessage.classList.add('hidden');
            }
            
            // 1. Group ALL posts (threads and replies) by their parentId
            const allPostsByParent = posts.reduce((acc, post) => {
                const parentId = post.parentId || 'root'; 
                if (!acc[parentId]) acc[parentId] = [];
                acc[parentId].push(post);
                return acc;
            }, {});
            
            // 2. Main threads are posts whose parentId is null
            const threads = posts.filter(p => p.parentId === null);

            // 3. Apply 'Show My Posts Only' filter to determine visible main threads
            // A thread is visible if the current user posted the thread OR if the current user replied to it.
            const visibleThreads = showMyPostsOnly 
                ? threads.filter(t => t.userId === currentUserId || (allPostsByParent[t.id] && allPostsByParent[t.id].some(r => r.userId === currentUserId)))
                : threads;

            // Note: visibleThreads retains the order of the underlying allPostsCache,
            // which is now sorted by likeCount (desc) then timestamp (desc).
            
            visibleThreads.forEach(thread => {
                // Use the recursive function to render the thread and its children
                const threadElement = renderPostAndChildren(thread, allPostsByParent, false);
                threadsContainer.appendChild(threadElement);
            });

            if (visibleThreads.length === 0) {
                 const message = showMyPostsOnly 
                    ? 'You have not posted any threads or replies yet.'
                    : 'No posts yet! Be the first to start a thread.';
                    
                 threadsContainer.innerHTML = `<p class="text-center text-white p-8" style="text-shadow: 0 0 5px black;">${message}</p>`;
            }
        }

        /** Toggles the visibility of a reply form */
        window.toggleReplyForm = function(threadId) {
            const form = document.getElementById(`reply-form-${threadId}`);
            if (form) {
                form.classList.toggle('hidden');
            }
        }
        
        // --- Initialization ---
        setupAuthAndFirebase();

    </script>
</body>
</html>
